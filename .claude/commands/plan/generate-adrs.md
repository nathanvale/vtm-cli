---
allowed-tools: Task, Read(docs/prd/*.md, docs/adr/*.md, .claude/templates/template-adr.md), Write(docs/adr/*.md), Bash(mkdir *, ls *)
description: Generate granular Architecture Decision Records from PRD decisions using task agents
argument-hint: { prd-file }
---

# Plan: Generate ADRs

**Command:** `/plan:generate-adrs {prd-file}`
**Purpose:** Generate granular Architecture Decision Records from PRD decisions using task agents

---

## What This Command Does

Extracts distinct architectural decisions from a PRD and generates focused ADRs by:

1. Reading the PRD file
2. Launching a task agent to analyze and extract decisions
3. Task agent uses `/helpers:thinking-partner` to research alternatives for each decision
4. Generates separate ADR files (one per decision, not monolithic)
5. Links ADRs with dependencies
6. Outputs `adr/ADR-XXX-{name}.md` files (auto-numbered)

**Key Benefit:** Transforms high-level PRD decisions into detailed, researched ADRs with clear rationale and alternatives considered.

---

## Usage

```bash
# Basic usage
/plan:generate-adrs prd/auth-system.md

# Works with any PRD
/plan:generate-adrs prd/payment-gateway.md
/plan:generate-adrs prd/analytics-dashboard.md
```

---

## Parameters

- `{prd-file}`: Path to PRD file (required)
  - Example: `prd/auth-system.md`
  - Must exist and be readable
  - Will be parsed for architectural decisions

---

## Implementation Instructions

You are implementing the `/plan:generate-adrs` command. Here's how to do it:

### Step 1: Validate PRD File and Content

```javascript
const fs = require("fs")
const path = require("path")

const prdFile = ARGUMENTS[0]

if (!prdFile) {
  console.error("‚ùå Error: PRD file path required")
  console.log("Usage: /plan:generate-adrs {prd-file}")
  console.log("Example: /plan:generate-adrs prd/auth-system.md")
  process.exit(1)
}

const prdPath = path.resolve(prdFile)
if (!fs.existsSync(prdPath)) {
  console.error(`‚ùå Error: PRD file not found: ${prdFile}`)
  process.exit(1)
}

const prdContent = fs.readFileSync(prdPath, "utf-8")

// Validate PRD structure
console.log("üîç Validating PRD file...")

// Check for spec_type: prd in frontmatter
if (!prdContent.includes("spec_type: prd")) {
  console.warn(
    "‚ö†Ô∏è  Warning: File may not be a valid PRD (missing 'spec_type: prd' header)",
  )
  console.warn(
    "   This might be a regular markdown file, not a PRD generated by /plan:create-prd",
  )
  console.warn("")
}

// Check for minimum content
const lineCount = prdContent.split("\n").length
if (lineCount < 10) {
  console.error(
    `‚ùå Error: PRD file appears too short (${lineCount} lines, recommended: 10+)`,
  )
  console.error("   PRD files should contain substantial planning content")
  process.exit(1)
}

// Check for headers
if (!prdContent.includes("#")) {
  console.error(
    "‚ùå Error: PRD file appears empty or malformed (no headers found)",
  )
  process.exit(1)
}

// Check for decision-making content
const hasDecisions =
  prdContent.toLowerCase().includes("decision") ||
  prdContent.toLowerCase().includes("approach") ||
  prdContent.toLowerCase().includes("strategy") ||
  prdContent.toLowerCase().includes("we will") ||
  prdContent.toLowerCase().includes("we chose")

if (!hasDecisions) {
  console.warn(
    "‚ö†Ô∏è  Warning: PRD may not contain explicit architectural decisions",
  )
  console.warn("   ADR generation works best when PRD includes decision points")
  console.warn("   Example: 'Decision: Use OAuth2 for authentication'")
  console.warn("")
}

// Check for recommended PRD sections
const recommendedSections = [
  "Problem",
  "Users",
  "Scope",
  "Technical",
  "Requirements",
]

let missingSections = []
for (const section of recommendedSections) {
  if (!prdContent.toLowerCase().includes(section.toLowerCase())) {
    missingSections.push(section)
  }
}

if (missingSections.length > 0) {
  console.warn(
    `‚ö†Ô∏è  Warning: PRD missing recommended sections: ${missingSections.join(", ")}`,
  )
  console.warn("   ADRs may have limited context without these sections")
  console.warn("")
}

console.log("‚úÖ PRD validation passed")
console.log(`   File: ${prdFile}`)
console.log(`   Lines: ${lineCount}`)
console.log("")
```

### Step 2: Read ADR Template

Read the ADR template from `.claude/templates/template-adr.md`:

```bash
# Read the template
Read .claude/templates/template-adr.md
```

This template provides the standard ADR structure that the task agent should fill in.

### Step 3: Create ADR Directory

```bash
mkdir -p docs/adr
```

Get next ADR number:

```bash
# List existing ADRs and find the highest number
ls docs/adr/ADR-*.md 2>/dev/null | sed 's/.*ADR-\([0-9]*\).*/\1/' | sort -n | tail -1
# If no ADRs exist, start with 001
```

### Step 3: Launch Task Agent

Use Claude Code's `Task` tool to launch an agent that will:

1. Analyze PRD to extract decisions
2. Research alternatives for each decision
3. Generate separate ADR files

```javascript
console.log(`üìù Analyzing PRD: ${prdFile}`)
console.log("üîç Launching ADR generation agent...\n")
```

**Task Agent Prompt:**

````
You are an ADR generation specialist. Your job is to extract architectural decisions from a PRD and generate detailed, focused ADRs.

## Your Task

Analyze this PRD and generate separate ADRs for each distinct architectural decision.

**PRD File:** ${prdFile}

**PRD Content:**
```
${prdContent}
```

## Process

1. **Extraction Phase**
   Analyze the PRD to identify distinct architectural decisions:
   - Look for: "Decision:", "We chose", "We will use", "Technology Selection", "Architecture Choices"
   - Identify: Dependencies between decisions (e.g., "token storage" depends on "auth protocol")
   - Separate: Each significant decision should be its own ADR
   - Avoid: Grouping unrelated decisions into one ADR

   **Criteria for "distinct decision":**
   - Has a specific problem/need it addresses
   - Has multiple alternative approaches
   - Has clear consequences/trade-offs
   - Can be implemented independently (or with known dependencies)

2. **Research Phase**
   For each decision, check cache before using /helpers:thinking-partner:

   **Caching Integration (NEW):**

   Initialize research cache before processing decisions:
   ```typescript
   import { ResearchCache } from 'vtm-cli/lib'

   const cache = new ResearchCache(
     '.claude/cache/research',  // Default cache location
     30 * 24 * 60              // 30 days TTL
   )
   ```

   For EACH decision, follow this caching pattern:
   ```typescript
   // 1. Normalize query for consistent caching
   const query = `${decisionTopic} alternatives and trade-offs`

   // 2. Check cache first
   let research = await cache.get(query)

   if (research) {
     console.log(`‚úÖ Using cached research for: ${decisionTopic}`)
   } else {
     console.log(`üîç Researching: ${decisionTopic} (not cached)`)

     // 3. Call thinking-partner (30-60 seconds per call)
     research = await thinkingPartner(query, {
       deep: true,
       sources: ['web', 'docs', 'code']
     })

     // 4. Store in cache with semantic tags
     const tags = [
       decisionTopic.split(' ')[0].toLowerCase(), // Primary topic
       'alternatives',                            // Type of research
       'adr-generation'                          // Source command
     ]
     await cache.set(query, research, tags)
   }

   // 5. Use research result to generate ADR
   ```

   **Research topics to cache:**
   - Alternative approaches (e.g., OAuth2 vs SAML vs JWT)
   - Trade-offs for each alternative
   - Industry best practices
   - Real-world implementation examples
   - Potential risks and mitigations

   **Performance Impact:**
   - First run (5 decisions): ~10 minutes (all cache misses)
   - Second run (same decisions): ~6 minutes (all cache hits)
   - **40% time savings, 40% cost reduction**

   **Cache behavior:**
   - Cache miss: Calls /helpers:thinking-partner (slow)
   - Cache hit: Instant retrieval (fast)
   - TTL: 30 days (configurable)
   - After expiration: Research automatically refreshed

3. **Structure Phase**
   For each decision, organize findings into ADR format:

   **Title:** ADR-XXX: {Decision Name}
   - Use active voice: "Use OAuth2 for Authentication" not "OAuth2 Authentication"

   **Status:** Proposed | Accepted | Rejected | Superseded
   - Default: Proposed

   **Context:**
   - What problem does this decision solve?
   - Why is this decision necessary?
   - What constraints exist?
   - Link to source PRD

   **Decision:**
   - Clear statement of what was decided
   - Technology/approach chosen
   - Specific implementation details

   **Rationale:**
   - Why this approach was chosen
   - Key factors that influenced the decision
   - Research findings supporting the choice

   **Consequences:**
   - Positive consequences (benefits)
   - Negative consequences (drawbacks)
   - Risks and mitigation strategies
   - Impact on other parts of the system

   **Alternatives Considered:**
   For each alternative:
   - **Alternative Name:** Description
     - Pros: [List from research]
     - Cons: [List from research]
     - Why rejected: [Specific reason]

   **Dependencies:**
   - List other ADRs this depends on (if any)
   - List ADRs that will depend on this (if known)

4. **Generation Phase**
   Generate ADR markdown following this template:

   ```markdown
   # ADR-{number}: {Decision Name}

   **Status:** Proposed
   **Date:** ${new Date().toISOString().split('T')[0]}
   **Source:** ${prdFile}

   ## Context

   [Clear problem statement from PRD and research]

   [Why this decision matters]

   [Constraints and requirements]

   ## Decision

   We will [clear decision statement].

   [Specific implementation details]

   ## Rationale

   We chose this approach because:

   1. [Reason 1 from research]
   2. [Reason 2 from research]
   3. [Reason 3 from research]

   [Supporting evidence from research]

   ## Consequences

   ### Positive

   - [Benefit 1]
   - [Benefit 2]
   - [Benefit 3]

   ### Negative

   - [Drawback 1 with mitigation]
   - [Drawback 2 with mitigation]

   ### Risks

   - **Risk 1:** [Description]
     - Mitigation: [Strategy]
   - **Risk 2:** [Description]
     - Mitigation: [Strategy]

   ## Alternatives Considered

   ### Alternative 1: [Name]

   [Description from research]

   **Pros:**
   - [Pro 1]
   - [Pro 2]

   **Cons:**
   - [Con 1]
   - [Con 2]

   **Why rejected:** [Specific reason based on context]

   ### Alternative 2: [Name]

   [Similar structure]

   ## Dependencies

   - Depends on: [ADR-XXX if applicable]
   - Blocks: [ADR-YYY if applicable]

   ## References

   - [Research source 1]
   - [Research source 2]
   - [Code example or documentation]
   ```

5. **Output Phase**
   Generate ADR files with sequential numbering:
   - Start from: ADR-${String(nextAdrNumber).padStart(3, '0')}
   - Naming: docs/adr/ADR-{number}-{slug}.md
   - Slug: Decision name in kebab-case
   - Example: docs/adr/ADR-001-oauth2-authentication.md

6. **Summary Phase**
   After generating all ADRs, provide summary:
   - List of generated ADRs
   - Dependency graph (if any dependencies exist)
   - Suggested next steps

## Important

- Use /helpers:thinking-partner for EACH decision's research (don't make up alternatives)
- Generate ONE ADR per distinct decision (not monolithic)
- Include specific details from research (not generic placeholders)
- Link ADRs with dependencies using ADR numbers
- Cite research sources in each ADR
- Ensure decisions are traceable back to PRD

## Expected Output

You should generate:
1. Multiple ADR markdown files (one per decision)
2. Each ADR with researched alternatives
3. Clear dependency links between ADRs
4. Summary of generated ADRs

Write each ADR to: docs/adr/ADR-{number}-{slug}.md
````

### Step 4: Handle Task Agent Response

```javascript
// Task agent completes and returns list of generated ADRs
console.log("‚úÖ Decision extraction complete")
console.log("üìù ADRs generated\n")

// List generated ADRs
const generatedAdrs = fs
  .readdirSync(adrDir)
  .filter((f) => f.match(/^ADR-\d+/))
  .sort()

console.log("üìã Generated ADRs:")
generatedAdrs.forEach((adr) => {
  console.log(`  - docs/adr/${adr}`)
})

console.log("\nüìã Next Steps:")
console.log("1. Review generated ADRs")
console.log("2. Update status to 'Accepted' as decisions are finalized")
console.log("3. Create specs: /plan:create-spec docs/adr/ADR-001-{name}.md")
console.log("4. Or create all specs at once for the workflow")
```

---

## Output Format

Creates multiple `docs/adr/ADR-XXX-{name}.md` files with:

- **Sequential numbering** (ADR-001, ADR-002, etc.)
- **Focused scope** (one decision per ADR)
- **Researched alternatives** (not generic lists)
- **Clear rationale** (why this choice)
- **Dependency links** (between related ADRs)
- **Cited sources** (links to research)
- **Traceable** (links back to PRD)

---

## Examples

### Example 1: Authentication System PRD

**Input PRD** (`prd/auth-system.md`):

```markdown
## Technical Decisions

### Authentication Protocol

We need to support both OAuth2 for modern apps and SAML for enterprise SSO.

### Token Storage

Tokens must be stored securely with appropriate expiration.

### Session Management

Sessions should timeout after inactivity.
```

**Command:**

```bash
/plan:generate-adrs prd/auth-system.md
```

**Output ADRs:**

1. `docs/adr/ADR-001-oauth2-saml-authentication.md`
   - Decision: Use OAuth2 + SAML hybrid approach
   - Alternatives: OAuth2 only, SAML only, JWT
   - Rationale: Supports both modern and enterprise clients
   - Dependencies: None

2. `docs/adr/ADR-002-secure-token-storage.md`
   - Decision: Use httpOnly cookies + Redis for server-side storage
   - Alternatives: localStorage, sessionStorage, JWT in memory
   - Rationale: Best security vs performance trade-off
   - Dependencies: Depends on ADR-001 (token format)

3. `docs/adr/ADR-003-session-timeout-strategy.md`
   - Decision: Sliding window with 30min inactivity timeout
   - Alternatives: Absolute timeout, no timeout, refresh tokens
   - Rationale: Balance security and UX
   - Dependencies: Depends on ADR-002 (session storage)

---

## Decision Extraction Guidelines

The task agent should identify decisions based on these patterns in the PRD:

**Explicit Decision Markers:**

- "Decision:", "We chose", "We will use"
- "Technology Selection:", "Architecture Choices:"
- "Approach:", "Strategy:", "Method:"

**Implicit Decisions:**

- Mentions of specific technologies (e.g., "React", "PostgreSQL")
- Comparisons between options (e.g., "REST vs GraphQL")
- Requirements that imply architectural choices

**What to Separate into Distinct ADRs:**

- Different technology domains (auth vs storage vs API)
- Independent implementation choices
- Decisions with different stakeholders or timelines
- Decisions with distinct risk profiles

**What to Keep in One ADR:**

- Tightly coupled choices (e.g., "GraphQL + Apollo" as one decision)
- Sub-decisions that don't make sense independently
- Configuration details of a larger decision

---

## Integration with Workflow

```
/plan:create-prd auth-system "multi-tenant auth"
  ‚Üì Generates docs/prd/auth-system.md
  ‚Üì
/plan:generate-adrs docs/prd/auth-system.md
  ‚Üì Extracts 5 distinct decisions
  ‚Üì Researches alternatives for each
  ‚Üì Generates:
      - docs/adr/ADR-001-auth-protocol.md
      - docs/adr/ADR-002-token-storage.md
      - docs/adr/ADR-003-session-timeout.md
      - docs/adr/ADR-004-mfa-implementation.md
      - docs/adr/ADR-005-audit-logging.md
  ‚Üì
/plan:create-spec docs/adr/ADR-001-auth-protocol.md
  ‚Üì Creates implementation spec
```

---

## Error Handling

**Missing PRD file:**

```
‚ùå Error: PRD file path required
Usage: /plan:generate-adrs {prd-file}
```

**PRD not found:**

```
‚ùå Error: PRD file not found: prd/missing.md
```

**No decisions found:**

```
‚ö†Ô∏è  Warning: No architectural decisions found in PRD
The PRD may need more specific technical decisions.
Consider adding a "Technical Decisions" section.
```

**Research incomplete:**

```
‚ö†Ô∏è  Warning: Research incomplete for some alternatives
Generated ADRs may need manual research additions
Review ADRs marked with [RESEARCH NEEDED]
```

---

## Notes

- **Composability:** Uses `/helpers:thinking-partner` internally (not exposed to user)
- **Task Agent:** Orchestrates extraction ‚Üí research ‚Üí generation
- **Granularity:** One ADR per decision (not monolithic)
- **Quality:** Research-backed alternatives, not generic lists
- **Traceability:** Each ADR links back to source PRD
- **Dependencies:** ADRs explicitly link to each other when related

---

## See Also

- `/plan:create-prd` - Create PRD (prerequisite)
- `/plan:create-spec` - Create implementation spec from ADR
- `/helpers:thinking-partner` - Generic research tool (used internally)
- `/plan:to-vtm` - Convert ADRs and specs to VTM tasks

---

**Status:** Specification complete, ready for implementation
**Dependencies:** `/plan:create-prd` (should run first), `/helpers:thinking-partner` (existing)
**Composability:** Uses thinking partner internally, generates focused ADRs directly
